{
  "hash": "f0385c857787e781f5876b8054253c55",
  "result": {
    "engine": "knitr",
    "markdown": "# Frailty models for clustered data {-}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(survival)\nlibrary(parfm)\nlibrary(tibble)\nlibrary(dplyr)\n```\n:::\n\n\n\n\nThe Diabetic Retinopathy Study was conducted in the US by the National Eye Institute to **assess the effect of laser photocoagulation in delaying onset of severe visual loss (\"blindness\")** in patients with diabetic retinopathy. One eye of each patient was randomly selected for photocoagulation and the other was observed without treatment. The patients were followed over several years for the occurrence of blindness (**event = blindness**) in their left and right eyes. Censoring is caused by death, dropout, or end of the study. We consider only a subset of the original data set containing $197$ high risk patients. See Huster et al, 1989, Biometrics, for a discussion and further references.\n\nThere are **two lines for each patient** in the data set: *one line per eye*.\nThe variables are:\n\n- id: patient number\n- trteye: treated eye (1=right, 2=left)\n- ageonset: age at diagnosis of diabetes\n- typediab: type of diabetes (1= juvenile age at onset < 20 years , 2=adult)\n- time: follow-up time in months\n- status: status for eye (0=censored, 1=blindness)\n- trt: treatment of eye (1=control eye, 2=treated eye)\n\nBefore you start, you will have to read the data. Use the R-command:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\neye=read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/retinopathy.txt\", header=T) %>% as_tibble()\neye\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 394 × 7\n      id trteye ageonset typediab status  time   trt\n   <int>  <int>    <int>    <int>  <int> <dbl> <int>\n 1     5      2       28        2      0 46.2      1\n 2    14      1       12        1      1 31.3      1\n 3    16      1        9        1      0 42.3      1\n 4    25      2        9        1      0 20.6      1\n 5    29      2       13        1      1  0.3      1\n 6    46      1       12        1      1 54.3      1\n 7    49      1        8        1      1 10.8      1\n 8    56      1       12        1      0 23.2      1\n 9    61      1       16        1      0  1.47     1\n10    71      1       21        2      1 13.8      1\n# ℹ 384 more rows\n```\n\n\n:::\n:::\n\n\n\n\nWe start out by only using treatment as a covariate.\n\na) We first fit a model with Weibull baseline and no frailty by the command:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnofrail.model = parfm(Surv(time,status)~factor(trt),data=eye)\nnofrail.model\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFrailty distribution: none \nBaseline hazard distribution: Weibull \nLoglikelihood: -836.379 \n\n             ESTIMATE SE    p-val    \nrho           0.810   0.058          \nlambda        0.032   0.008          \nfactor(trt)2 -0.790   0.169 <.001 ***\n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nci.parfm(nofrail.model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n               low    up\nfactor(trt)2 0.326 0.632\n```\n\n\n:::\n:::\n\n\n\nPerform the command, and make sure that you understand what the output tells you.\n\nb) We then fit a model with Weibull baseline and gamma frailty:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfrail.model = parfm(Surv(time,status)~factor(trt),cluster=\"id\", frailty=\"gamma\", data=eye)\nfrail.model\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFrailty distribution: gamma \nBaseline hazard distribution: Weibull \nLoglikelihood: -827.744 \n\n             ESTIMATE SE    p-val    \ntheta         1.040   0.329          \nrho           0.948   0.075          \nlambda        0.028   0.007          \nfactor(trt)2 -0.960   0.182 <.001 ***\n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nKendall's Tau: 0.342 \n```\n\n\n:::\n:::\n\n\n\n\nPerform the command, and compare with the result for the model without frailty. Is there a **significant frailty effect**?\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nLR=2*(attributes(frail.model)$loglik - attributes(nofrail.model)$loglik)\nLR\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 17.26943\n```\n\n\n:::\n\n```{.r .cell-code}\n(1-pchisq(LR, 1))/2 # YES!\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1.621814e-05\n```\n\n\n:::\n:::\n\n\n\n\n- **Significant risk variation between the clusters (individuals here)!**\n\nc) Fit a model with gamma frailty and treatment and age at onset as covariates. Is there a significant effect of age at onset? What about type of diabetes?\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfrail.model.ageonset = parfm(Surv(time,status)~factor(trt) + ageonset, cluster=\"id\", frailty=\"gamma\", data=eye)\nfrail.model.ageonset # NO! (coef close to 0, p-value large)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFrailty distribution: gamma \nBaseline hazard distribution: Weibull \nLoglikelihood: -827.469 \n\n             ESTIMATE SE    p-val    \ntheta         1.034   0.328          \nrho           0.948   0.075          \nlambda        0.025   0.008          \nfactor(trt)2 -0.966   0.182 <.001 ***\nageonset      0.006   0.008 0.456    \n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nKendall's Tau: 0.341 \n```\n\n\n:::\n\n```{.r .cell-code}\nfrail.model.typediab = parfm(Surv(time,status)~factor(trt) + factor(typediab), cluster=\"id\", frailty=\"gamma\", data=eye)\nfrail.model.typediab # NO! (coef close to 0, p-value large)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFrailty distribution: gamma \nBaseline hazard distribution: Weibull \nLoglikelihood: -827.73 \n\n                  ESTIMATE SE    p-val    \ntheta              1.037   0.329          \nrho                0.947   0.075          \nlambda             0.028   0.008          \nfactor(trt)2      -0.961   0.182 <.001 ***\nfactor(typediab)2  0.040   0.232 0.864    \n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nKendall's Tau: 0.341 \n```\n\n\n:::\n:::\n\n\n\n\nd) Fit a **Cox frailty model** (with gamma frailty) using treatment as the only covariate (see lectures for R commands). Compare the results with those you obtained in question b.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfrail.cox = coxph(Surv(time,status) ~ factor(trt) + frailty(id), data=eye)\nfrail.cox\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = Surv(time, status) ~ factor(trt) + frailty(id), \n    data = eye)\n\n                coef se(coef)     se2   Chisq   DF       p\nfactor(trt)2  -0.910    0.174   0.171  27.295  1.0 1.7e-07\nfrailty(id)                           114.448 84.6   0.017\n\nIterations: 6 outer, 30 Newton-Raphson\n     Variance of random effect= 0.854   I-likelihood = -850.9 \nDegrees of freedom for terms=  1.0 84.6 \nLikelihood ratio test=201  on 85.6 df, p=3e-11\nn= 394, number of events= 155 \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# cox with no frailty\ncox = coxph(Surv(time, status) ~ factor(trt), data = eye)\n\nLRcox = 2*(frail.cox$history$frailty$c.loglik - cox$loglik[2])\nLRcox # log-likelihood ratio\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 11.88032\n```\n\n\n:::\n\n```{.r .cell-code}\n1 - pchisq(LRcox,df=1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.0005673029\n```\n\n\n:::\n:::\n\n\n\n\ne) Finally we want to illustrate how stratified Cox regression can be used to analyse paired survival data like the ones we have in the present situation. We may fit a stratified Cox model with **a separate baseline for each patient (per eye pair pretty much)** by the commands:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\neyefit.strat=coxph(Surv(time,status)~trt+strata(id),data=eye)\nsummary(eyefit.strat)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = Surv(time, status) ~ trt + strata(id), data = eye)\n\n  n= 394, number of events= 155 \n\n       coef exp(coef) se(coef)      z Pr(>|z|)    \ntrt -0.9623    0.3820   0.2016 -4.773 1.82e-06 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n    exp(coef) exp(-coef) lower .95 upper .95\ntrt     0.382      2.618    0.2573    0.5672\n\nConcordance= 0.748  (se = 0.058 )\nLikelihood ratio test= 25.49  on 1 df,   p=4e-07\nWald test            = 22.78  on 1 df,   p=2e-06\nScore (logrank) test = 24.59  on 1 df,   p=7e-07\n```\n\n\n:::\n:::\n\n\n\n\nExplain the idea behind such an approach, and discuss how it compares to the approach in question d).\n\nWe got same approximately results! Why? See equation (slide no. 24):\n$a_{ij}(t|Z_i) = Z_i a_0(t) e^{\\beta x_{ij}}$\n\n- Cox model uses different baseline hazards per stratum ($Z_i=1$)\n- Parametric Frailty models are better in most practical applications ($a_0(t)$ same for all individuals, $Z_i$ varies and is estimated)\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}