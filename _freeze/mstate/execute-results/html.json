{
  "hash": "fe73ff68d41c8aae8b28d6f0382fcbeb",
  "result": {
    "markdown": "# Multi-state models {-}\n\n\n\n\n::: {.cell hash='mstate_cache/html/libs_8149a833c1d8fad4a37ed564498f2e8e'}\n\n```{.r .cell-code}\nlibrary(survival)\nlibrary(mstate)\nlibrary(tibble)\nlibrary(dplyr)\n```\n:::\n\n\nIn this exercise, we will see how we may find the Nelson-Aalen estimates for the cumulative transition intensities and the Aalen-Johansen estimates for the transition probabilities in a Markov illness-death model. To this end, we will use the **bone marrow transplantation data** described in example 1.13 in the ABG-book and used for illustration in example 3.16. To read the data into R you may give the command:\n\n\n::: {.cell hash='mstate_cache/html/unnamed-chunk-1_4b37dde43f66d257d65569994397fba0'}\n\n```{.r .cell-code}\nbonemarrow = read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/bone-marrow.txt\",header=T) %>% as_tibble()\nbonemarrow %>% select(T2, DF, TP, P)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 137 × 4\n      T2    DF    TP     P\n   <int> <int> <dbl> <int>\n 1  2081     0    13     1\n 2  1602     0    18     1\n 3  1496     0    12     1\n 4  1462     0    13     1\n 5  1433     0    12     1\n 6  1377     0    12     1\n 7  1330     0    17     1\n 8   996     0    12     1\n 9   226     0    10     1\n10  1199     0    29     1\n# ℹ 127 more rows\n```\n:::\n:::\n\n\n**Bone marrow transplantation data**:\n\n-   g =\\> Disease Group (1: ALL, 2: AML Low Risk, 3: AML High Risk)\n-   T1 =\\> Time To Death Or On Study Time\n-   **T2 =\\> Disease Free Survival Time (Time To Relapse, Death Or End Of Study)**\n-   D =\\> Death Indicator (1: Dead, 0: Alive)\n-   R =\\> Relapse Indicator (1: Relapsed, 0: Disease Free)\n-   **DF =\\> Disease Free Survival Indicator (1: Dead Or Relapsed, 0: Alive Disease Free)**\n-   TA =\\> Time To Acute Graft-Versus-Host Disease\n-   A =\\> Acute GVHD Indicator (1: Developed Acute GVHD, 0: Never Developed Acute GVHD)\n-   TC =\\> Time To Chronic Graft-Versus-Host Disease\n-   C =\\> Chronic GVHD Indicator (1-Developed Chronic GVHD, 0:Never Developed Chronic GVHD)\n-   **TP =\\> Time To Return of Platelets to Normal Levels**\n-   **P =\\> Platelet Recovery Indicator (1: Platelets Returned To Normal, 0-Platelets Never Returned to Normal)**\n-   Z1 =\\> Patient Age In Years\n-   Z2 =\\> Donor Age In Years\n-   Z3 =\\> Patient Sex (1-Male, 0-Female)\n-   Z4 =\\> Donor Sex (1: Male, 0: Female)\n-   Z5 =\\> Patient CMV Status (1: CMV Positive, 0: CMV Negative)\n-   Z6 =\\> Donor CMV Status (1: CMV Positive, 0: CMV Negative)\n-   Z7 =\\> Waiting Time to Transplant In Days\n-   Z8 =\\> FAB (1: FAB Grade 4 Or 5 and AML, 0: Otherwise)\n-   Z9 =\\> Hospital (1:The Ohio State University, 2: Alferd , 3: St. Vincent, 4: Hahnemann)\n-   Z10 =\\> MTX Used as a Graft-Versus-Host- Prophylactic (1:Yes, 0:No)\n\nThe data contain information for $137$ patients with acute leukemia who had a bone marrow transplantation. The patients were followed for a maximum of seven years, and times to relapse and death were recorded. It was also recorded if and when the platelet count of a patient returned to a self-sustaining level. The possible events for a patient may be described by an illness-death model without recovery with the **three states** \"transplanted\", \"platelet recovered\", and \"relapsed or dead\". A patient starts out in state \"transplanted\" at time zero when he/she gets the bone marrow transplant. If the platelets recover, the patient moves to state \"platelet recovered\", and if he/she then relapses or dies, the patient moves on to state \"relapsed or dead\". If the patient relapses or dies without the platelets returning to a normal level, he moves directly from state \"transplanted\" to state \"relapsed or dead\".\n\nTo find the Nelson-Aalen estimates and the empirical transition probabilities (i.e. Aalen-Johansen estimates) we will use the `mstate` package so this has to be installed and loaded.\n\nWe start out by defining the states and the possible transitions between them. This is achieved by the command:\n\n\n::: {.cell hash='mstate_cache/html/unnamed-chunk-2_89696138dea35b9d808329bcd1bfd956'}\n\n```{.r .cell-code}\ntmat = transMat(x = list(c(2,3),c(3),c()), names = c(\"transplanted\",\"recovered\",\"relapsed.dead\"))\ntmat\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               to\nfrom            transplanted recovered relapsed.dead\n  transplanted            NA         1             2\n  recovered               NA        NA             3\n  relapsed.dead           NA        NA            NA\n```\n:::\n:::\n\n\nTo perform the estimation, we need to convert the data-frame to a **long format**, where there are 2-3 lines for each patient:\n\n\n::: {.cell hash='mstate_cache/html/unnamed-chunk-3_67a07642781eae30d7b737e2ea202e2a'}\n\n```{.r .cell-code}\nbonemarrow.long = msprep(time=c(NA,\"TP\",\"T2\"), status=c(NA,\"P\",\"DF\"),data=bonemarrow,trans=tmat)\nbonemarrow.long %>% as_tibble()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 394 × 8\n      id  from    to trans Tstart Tstop  time status\n   <dbl> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl>  <dbl>\n 1     1     1     2     1      0    13    13      1\n 2     1     1     3     2      0    13    13      0\n 3     1     2     3     3     13  2081  2068      0\n 4     2     1     2     1      0    18    18      1\n 5     2     1     3     2      0    18    18      0\n 6     2     2     3     3     18  1602  1584      0\n 7     3     1     2     1      0    12    12      1\n 8     3     1     3     2      0    12    12      0\n 9     3     2     3     3     12  1496  1484      0\n10     4     1     2     1      0    13    13      1\n# ℹ 384 more rows\n```\n:::\n:::\n\n::: {.cell hash='mstate_cache/html/unnamed-chunk-4_091213b6f605a4b26cddf2fed755c3d5'}\n\n```{.r .cell-code}\n# example\nbonemarrow %>% as_tibble() %>% filter(T2 == 383)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 22\n      g    T1    T2     D     R    DF    TA     A    TC     C    TP     P    Z1\n  <int> <int> <int> <int> <int> <int> <int> <int> <int> <int> <dbl> <int> <int>\n1     1   417   383     1     1     1   417     0   417     0    16     1    15\n# ℹ 9 more variables: Z2 <int>, Z3 <int>, Z4 <int>, Z5 <int>, Z6 <int>,\n#   Z7 <int>, Z8 <int>, Z9 <int>, Z10 <int>\n```\n:::\n:::\n\n\nThen we fit a stratified Cox-model with no covariates (stratifying on the type of transition), extract the Nelson-Aalen estimates for the cumulative transition intensities and make a plot of these:\n\n\n::: {.cell hash='mstate_cache/html/unnamed-chunk-5_6f6309ffda7db8dd05842f0524cbd2df'}\n\n```{.r .cell-code}\ncox.bm=coxph(Surv(Tstart,Tstop,status)~strata(trans),data=bonemarrow.long, method=\"breslow\")\nhaz.bm=msfit(cox.bm,trans=tmat)\n\nplot(haz.bm,xlab=\"Days post-transplant\",xlim=c(0,1000),ylim=c(0,3.5))\n```\n\n::: {.cell-output-display}\n![](mstate_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nTo find the Aalen-Johansen estimates of the transition probabilities, we give the command:\n\n\n::: {.cell hash='mstate_cache/html/unnamed-chunk-6_9d2f3739720683c31496b1f4dd7413fb'}\n\n```{.r .cell-code}\nprob.bm = probtrans(haz.bm,predt=0)\n```\n:::\n\n\nWe may extract the empirical transition probabilities from state \"transplanted\" (state 1) by the command `prob.bm[[1]]`, and similarly we obtain the empirical transition probabilities from state \"recovered\" (state 2) by `prob.bm[[2]]`.\n\nThe transition probabilities may be plotted in a stacked manner or as separate estimates by the commands:\n\n\n::: {.cell hash='mstate_cache/html/unnamed-chunk-7_7f5e62d845093e7473dca46be368fddd'}\n\n```{.r .cell-code}\nplot(prob.bm,type=\"filled\",ord=c(2,1,3))\n```\n\n::: {.cell-output-display}\n![](mstate_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplot(prob.bm,type=\"filled\")\n```\n\n::: {.cell-output-display}\n![](mstate_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n:::\n\n\nProbability of being in each state:\n\n::: {.cell hash='mstate_cache/html/unnamed-chunk-8_a3f1d7db46e8497d57c7a90ae6eea595'}\n\n```{.r .cell-code}\nplot(prob.bm,type=\"single\",xlim=c(0,1000),col=1:3)\n```\n\n::: {.cell-output-display}\n![](mstate_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\na)  Perform the commands given above. Make sure that you understand what each of the commands and plots give you, and compare the results with those of example 3.16 in the ABG-book.\n\nb)  Above we used the probtrans command with the option predt=0. This gives transition probabilities from time s = 0 to time t. Also compute and plot the transition probabilities for $s = 14, 28$ and $42$. What can you learn from these plots?\n\n\n::: {.cell hash='mstate_cache/html/unnamed-chunk-9_b08313c359d020f10759c2ef250550ff'}\n\n```{.r .cell-code}\nprob.bm.14 = probtrans(haz.bm,predt=14)\nplot(prob.bm.14, type = \"single\", xlim = c(0,1000), col = 1:3, main = 's = 14')\n```\n\n::: {.cell-output-display}\n![](mstate_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='mstate_cache/html/unnamed-chunk-10_03ca530189659e625d86c668f7ba326e'}\n\n```{.r .cell-code}\nprob.bm.28 = probtrans(haz.bm, predt = 28)\nplot(prob.bm.28, type = \"single\", xlim = c(0,1000), col = 1:3, main = 's = 28')\n```\n\n::: {.cell-output-display}\n![](mstate_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='mstate_cache/html/unnamed-chunk-11_e781517858396cca97cd1bd44983f10c'}\n\n```{.r .cell-code}\nprob.bm.42 = probtrans(haz.bm,predt=42)\nplot(prob.bm.42, type = \"single\", xlim = c(0,1000), col = 1:3, main = 's = 42')\n```\n\n::: {.cell-output-display}\n![](mstate_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n- What if I start from state 2?\n\n::: {.cell hash='mstate_cache/html/unnamed-chunk-12_f3992986547889c66d4ac45063e95041'}\n\n```{.r .cell-code}\nplot(prob.bm.14, from = 2, type = \"single\", xlim = c(0,1000), col = 1:3, main = 's = 14 from 2nd Recovery state')\n```\n\n::: {.cell-output-display}\n![](mstate_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nReference:\n\n> Klein, JP and Moeschberger, ML (2003) Survival analysis. Techniques for Censored and Truncated Data (2nd edition). Springer-Verlag, New York.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}