{
  "hash": "b6cd167d05d1a424e2feed2d4e92efb6",
  "result": {
    "engine": "knitr",
    "markdown": "# Non-parametric estimators {-}\n\n## Nelson-Aalen estimator {-}\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(survival)\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n:::\n\n\n\n\nIn the period 1962-77 a total of $205$ patients with *malignant melanoma* (cancer of the skin) were operated at Odense University hospital in Denmark.\nA number of covariates were recorded at operation, and the patients were followed up until death or censoring at the **end of the study at December 31, 1977**. \nWe will study death from malignant melanoma considering death from other causes as censorings. (Source: Andersen, Borgan, Gill & Keiding, Springer, 1993.)\n\nYou may read the data into R by the command:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmelanoma = read.table(\"https://www.med.uio.no/imb/english/research/centres/ocbe/courses/imb9335/melanoma.txt\",header=T) %>% \n  as_tibble()\n```\n:::\n\n\n\n\nThe data are organized with one line for each of the 205 patients, and with the following variables in the seven columns:\n\n- status: status (1=death from disease, 2=censored, 4=death from other cause)\n- lifetime: life time from operation in years\n- ulcer: ulceration (1=present, 2=absent)\n- thickn: tumor thickness in mm\n- sex: 1=female, 2=male\n- age: age at operation in years\n- grthick: grouped tumor thickness [1: 0-1 mm (i.e. below 2 mm), 2: 2-4 mm (i.e. at least 2 mm, but below 5 mm) , 3: 5+ mm (i.e. 5 mm or more)]\n\nThe following commands provide a **Nelson-Aalen plot** for female melanoma patients. (The survival-library has to be loaded.)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurv.f = survival::survfit(Surv(lifetime,status==1) ~ 1, data = melanoma, \n  subset = (sex == 1), ctype = 1) # ctype = 1 means NA estimator\nsurv.m = survival::survfit(Surv(lifetime,status==1) ~ 1, data = melanoma, \n  subset = (sex == 2), ctype = 1)\n\nplot(surv.f, fun=\"cumhaz\", mark.time=FALSE, conf.type=\"plain\", xlim=c(0,10), ylim=c(0,0.80), main=\"Females\", xlab=\"Years since operation\", ylab=\"Cumulative hazard\")\n```\n\n::: {.cell-output-display}\n![](na_km_logrank_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplot(surv.m, fun=\"cumhaz\", mark.time=FALSE, conf.type=\"plain\", xlim=c(0,10), ylim=c(0,0.80), main=\"Males\", xlab=\"Years since operation\", ylab=\"Cumulative hazard\")\n```\n\n::: {.cell-output-display}\n![](na_km_logrank_files/figure-html/unnamed-chunk-2-2.png){width=672}\n:::\n:::\n\n\n\n\na)  Perform the commands and interpret the Nelson-Aalen plot.\n\nb)  Make a Nelson-Aalen plot for males and compare with the plot for females.\n\nTo plot the Nelson-Aalen estimates for both genders in the same figure, we may give the commands:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurv.sex = survival::survfit(Surv(lifetime,status==1) ~ strata(sex), data=melanoma, ctype=1)\n\nplot(surv.sex, fun=\"cumhaz\", mark.time=FALSE, lty=1:2, xlim=c(0,10), ylim=c(0,0.80), main=\"Gender\", xlab=\"Years since operation\", ylab=\"Cumulative hazard\")\n\nlegend(\"topleft\", c(\"Females\",\"Males\"), lty=1:2)\n```\n\n::: {.cell-output-display}\n![](na_km_logrank_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n\nc)  Perform the commands and inspect the plot.\n\n- Straight slope => **constant hazard** independent of gender\n\nd)  Make Nelson-Aalen plots for patients with ulceration present and absent and interpret the plots. (Ulceration is \"present\" if the surface of the tumor viewed in a microscope show signs of ulcers and \"absent\" otherwise.)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurv.ulcer = survival::survfit(Surv(lifetime,status==1) ~ strata(ulcer), data=melanoma, ctype=1)\n\nplot(surv.ulcer, fun=\"cumhaz\", mark.time=FALSE, lty=1:2, xlim=c(0,10), ylim=c(0,0.80), main=\"Ulceration\", xlab=\"Years since operation\", ylab=\"Cumulative hazard\")\n\nlegend(\"topleft\", c(\"Present\",\"Absent\"), lty=1:2)\n```\n\n::: {.cell-output-display}\n![](na_km_logrank_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\ne)  Make Nelson-Aalen plots for the three thickness groups 0-1 mm, 2-4 mm, 5+ mm and interpret the plots.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurv.grthick = survival::survfit(Surv(lifetime,status==1) ~ strata(grthick), data=melanoma, ctype=1)\n\nplot(surv.grthick, fun=\"cumhaz\", mark.time=FALSE, lty=1:3, xlim=c(0,10), \n  ylim=c(0,0.80), main=\"Tumor thickness\", xlab=\"Years since operation\", ylab=\"Cumulative hazard\")\n\nlegend(\"topleft\", c(\"0-1 mm\",\"2-4 mm\", \"5+ mm\"), lty=1:3)\n```\n\n::: {.cell-output-display}\n![](na_km_logrank_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n## Kaplan-Meier and log-rank test\n\nIn this exercise, we will use the Kaplan-Meier estimator and the log-rank test to study survival for the melanoma patients.\n\nWe will consider Kaplan-Meier estimates for the mortality from malignant melanoma treating death from other causes as censoring.\n\nWe may compute and plot the Kaplan-Meier estimate of the survival distribution for male patients by the commands (you need to load the survival-library)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit.m=survfit(Surv(lifetime,status==1)~1,data=melanoma, subset=(sex==2), conf.type=\"plain\")\nplot(fit.m, mark.time=FALSE, xlab=\"Years after operation\", main = \"Males\")\nabline(h = 0.75, col=\"red\")\nabline(h = 0.5, col=\"blue\")\n```\n\n::: {.cell-output-display}\n![](na_km_logrank_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\nTo obtain a summary of the results, you may give the command:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#?quantile.survfit\nsummary(fit.m)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall: survfit(formula = Surv(lifetime, status == 1) ~ 1, data = melanoma, \n    subset = (sex == 2), conf.type = \"plain\")\n\n  time n.risk n.event survival std.err lower 95% CI upper 95% CI\n 0.507     76       1    0.987  0.0131        0.961        1.000\n 0.559     75       1    0.974  0.0184        0.938        1.000\n 0.575     74       1    0.961  0.0223        0.917        1.000\n 0.636     73       1    0.947  0.0256        0.897        0.998\n 1.167     72       1    0.934  0.0284        0.878        0.990\n 1.449     70       1    0.921  0.0310        0.860        0.982\n 1.701     69       1    0.908  0.0333        0.842        0.973\n 1.723     68       1    0.894  0.0354        0.825        0.964\n 1.805     67       1    0.881  0.0373        0.808        0.954\n 1.967     66       1    0.867  0.0390        0.791        0.944\n 2.060     65       1    0.854  0.0407        0.774        0.934\n 2.134     64       1    0.841  0.0422        0.758        0.923\n 2.173     63       1    0.827  0.0435        0.742        0.913\n 2.649     62       1    0.814  0.0448        0.726        0.902\n 2.677     61       1    0.801  0.0461        0.710        0.891\n 2.852     60       1    0.787  0.0472        0.695        0.880\n 2.910     59       1    0.774  0.0482        0.680        0.869\n 2.945     58       1    0.761  0.0492        0.664        0.857\n 3.364     57       1    0.747  0.0501        0.649        0.846\n 3.932     55       1    0.734  0.0510        0.634        0.834\n 4.126     53       1    0.720  0.0519        0.618        0.822\n 4.153     51       1    0.706  0.0528        0.602        0.809\n 4.340     50       1    0.692  0.0536        0.587        0.797\n 4.630     47       1    0.677  0.0544        0.570        0.784\n 5.647     32       1    0.656  0.0567        0.545        0.767\n 5.762     29       1    0.633  0.0591        0.517        0.749\n 6.542     25       1    0.608  0.0619        0.487        0.729\n 7.027     22       1    0.580  0.0650        0.453        0.708\n 7.622     21       1    0.553  0.0675        0.420        0.685\n```\n\n\n:::\n:::\n\n\n\na) Perform these commands and interpret the Kaplan-Meier plot. Determine the lower quartile of the survival distribution for males with 95% confidence limits using the output from the summary-command. (Note that the lower quartile corresponds to 75% survival probability.)\n\n- Look at the **first time** the Survival probability falls below $75\\%$\n\nb) We may obtain the quartiles of the survival distribution for males by the command\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nquantile(fit.m)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$quantile\n      25       50       75 \n3.364384       NA       NA \n\n$lower\n      25       50       75 \n2.172603 6.542466       NA \n\n$upper\n      25       50       75 \n5.761644       NA       NA \n```\n\n\n:::\n:::\n\n\n\n\nPerform this command and compare with the result you obtained in a).\n\nc) Make a Kaplan-Meier plot for females, and determine the lower quartile for females with 95% confidence limits (if possible). Compare with the results for males.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit.f=survfit(Surv(lifetime,status==1)~1,data=melanoma, subset=(sex==1), conf.type=\"plain\")\nplot(fit.f, mark.time=FALSE, xlab=\"Years after operation\", main = \"Females\")\n```\n\n::: {.cell-output-display}\n![](na_km_logrank_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n```{.r .cell-code}\nquantile(fit.f)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$quantile\n      25       50       75 \n8.334247       NA       NA \n\n$lower\n     25      50      75 \n5.29589      NA      NA \n\n$upper\n25 50 75 \nNA NA NA \n```\n\n\n:::\n:::\n\n\n\nd) Use the log-rank test to test the null hypothesis that males and females have the same mortality from malignant melanoma:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvdiff(Surv(lifetime,status==1) ~ sex,data=melanoma)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\nsurvdiff(formula = Surv(lifetime, status == 1) ~ sex, data = melanoma)\n\n        N Observed Expected (O-E)^2/E (O-E)^2/V\nsex=1 126       28     37.1      2.25      6.47\nsex=2  79       29     19.9      4.21      6.47\n\n Chisq= 6.5  on 1 degrees of freedom, p= 0.01 \n```\n\n\n:::\n:::\n\n\n\nWhat may you conclude from the test?\n\ne) Make Kaplan-Meier plots for patients with ulceration present and absent and interpret the results. Is it possible to estimate the lower quartile for both ulceration groups? Estimate the lower quartile with confidence limits if possible. Is there a significant difference in cancer mortality for patients with ulceration present and absent?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(surv.ulcer, mark.time=FALSE, lty = 1:2, xlab=\"Years after operation\", main = \"Ulceration\")\nlegend(\"bottomleft\", c(\"Present\",\"Absent\"), lty=1:2)\n```\n\n::: {.cell-output-display}\n![](na_km_logrank_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nquantile(surv.ulcer)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$quantile\n                            25       50 75\nstrata(ulcer)=ulcer=1 2.690411 8.334247 NA\nstrata(ulcer)=ulcer=2       NA       NA NA\n\n$lower\n                            25       50 75\nstrata(ulcer)=ulcer=1 2.060274 4.728767 NA\nstrata(ulcer)=ulcer=2 7.621918       NA NA\n\n$upper\n                            25 50 75\nstrata(ulcer)=ulcer=1 4.126027 NA NA\nstrata(ulcer)=ulcer=2       NA NA NA\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# NO STRATA IN THE FORMULA NEEDED!\nsurvdiff(formula = Surv(lifetime, status == 1) ~ ulcer, data = melanoma)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\nsurvdiff(formula = Surv(lifetime, status == 1) ~ ulcer, data = melanoma)\n\n          N Observed Expected (O-E)^2/E (O-E)^2/V\nulcer=1  90       41     21.2      18.5      29.6\nulcer=2 115       16     35.8      10.9      29.6\n\n Chisq= 29.6  on 1 degrees of freedom, p= 5e-08 \n```\n\n\n:::\n:::\n\n\n\n\nf) Make Kaplan-Meier plots for the three thickness groups 0-1 mm, 2-4 mm, 5+ mm and interpret the plots. Estimate the lower quartile with confidence limits if possible. Is there a significant difference in cancer mortality between the three thickness groups?\n\n- Same procedure as above!!!\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}