<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Various code examples and methodologies for survival analysis">

<title>Censoring and time-dependent treatment strategies â€“ Material on Survival Analyses</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./sustained_trts.html" rel="next">
<link href="./point_trts.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./time_dep_trts.html">Censoring and time-dependent treatment strategies</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Material on Survival Analyses</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/bblodfon/surv-courses/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./na_km_logrank.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Non-parametric estimators</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cox_regr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cox Regression (low-dim)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cox_regr_high_dim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cox regression (high-dim)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./aalen.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Additive regression</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mstate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multi-state models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./frailty.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Frailty models for clustered data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ncc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Case-control studies</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./point_trts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Weighting and standardisation for point treatments</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./time_dep_trts.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Censoring and time-dependent treatment strategies</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sustained_trts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Marginal structural models and g-formula for sustained treatment strategies</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./causal_comp_risk.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Estimating causal effects on time-to-event outcomes under competing risks</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#data" id="toc-data" class="nav-link active" data-scroll-target="#data">Data</a></li>
  <li><a href="#aims" id="toc-aims" class="nav-link" data-scroll-target="#aims">Aims</a></li>
  <li><a href="#load-data-and-packages" id="toc-load-data-and-packages" class="nav-link" data-scroll-target="#load-data-and-packages">Load data and packages</a></li>
  <li><a href="#impact-of-baseline-treatment-status-and-using-ipcw" id="toc-impact-of-baseline-treatment-status-and-using-ipcw" class="nav-link" data-scroll-target="#impact-of-baseline-treatment-status-and-using-ipcw">Impact of baseline treatment status and using IPCW</a></li>
  <li><a href="#sustained-treatment-strategies-and-the-cloning-censoring-weighting-approach" id="toc-sustained-treatment-strategies-and-the-cloning-censoring-weighting-approach" class="nav-link" data-scroll-target="#sustained-treatment-strategies-and-the-cloning-censoring-weighting-approach">Sustained treatment strategies and the cloning-censoring-weighting approach</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Censoring and time-dependent treatment strategies</h1>
</div>



<div class="quarto-title-meta column-body">

    
  
    
  </div>
  


</header>


<section id="data" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="data">Data</h2>
<p>In this practical we will use a simulated data set, which includes data on 1000 individuals. The data include information on time-dependent treatment status <span class="math inline">\(A\)</span>, alongside three confounding variables (<span class="math inline">\(X,L_1,L_2\)</span>), two of which are time-dependent. Individuals were followed up for death for up to 3 years.</p>
<p><img src="img/dta_long_vars.png" class="img-fluid"></p>
<p>You can assume the relationships between the variables is as depicted in the discrete time DAG below, where <span class="math inline">\(Y_t\)</span> denotes the event indicator <span class="math inline">\(D\)</span> at time <span class="math inline">\(t\)</span> (<span class="math inline">\(t=1,2,3\)</span>).</p>
<p><img src="img/dag1.png" class="img-fluid"></p>
</section>
<section id="aims" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="aims">Aims</h2>
<p>This practical exercise is in two parts.</p>
<p>In <strong>Part A</strong> the aim is to estimate the effect of treatment status at time 0 (<span class="math inline">\(A_0\)</span>) on survival up to 3 years. <strong>This part ignores that treatment status changes over time</strong>, and it can be considered as a type of intention-to-treat (ITT) analysis. In this part we will also explore how to handle dependent censoring using inverse probability of censoring weights (IPCW).</p>
<p>In <strong>Part B</strong> the aim is to <strong>estimate the effect of sustained use of the treatment vs sustained non-use of the treatment</strong> on survival up to 3 years. We will use the cloning-censoring-weighting approach to estimate the population average (marginal) survival curves if everyone had received treatment <span class="math inline">\(A\)</span> from time 0 onwards (<span class="math inline">\(a_0=a_1=a_2=1\)</span>) and if everyone had not received treatment <span class="math inline">\(A\)</span> from time 0 onwards (<span class="math inline">\(a_0=a_1=a_2=0\)</span>).</p>
</section>
<section id="load-data-and-packages" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="load-data-and-packages">Load data and packages</h2>
<p>In this practical we will use the following packages: survival, tidyverse, splines.</p>
<div class="cell" data-result="false">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>dta <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"data/dta_long.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="impact-of-baseline-treatment-status-and-using-ipcw" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="impact-of-baseline-treatment-status-and-using-ipcw">Impact of baseline treatment status and using IPCW</h2>
<ol type="1">
<li>Check out the format of the data. How many rows of data are there? How many events?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#data for the first 5 individuals</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>dta[dta<span class="sc">$</span>id<span class="sc">%in%</span><span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    id visit T.start    T.stop D A           X          L1 L2
1.0  1     0       0 0.1158240 0 0 -0.06264538 -0.82276938  1
2.0  2     0       0 1.0000000 0 0  0.01836433 -1.79637025  0
2.1  2     1       1 2.0000000 0 0  0.01836433 -0.44665445  1
2.2  2     2       2 2.6234834 0 1  0.01836433 -0.34086086  1
3.0  3     0       0 1.0000000 0 1 -0.08356286  1.46577269  1
3.1  3     1       1 2.0000000 0 1 -0.08356286  1.48940024  1
3.2  3     2       2 3.0000000 0 0 -0.08356286 -1.13274309  0
4.0  4     0       0 0.4539474 0 1  0.15952808  0.66796553  1
5.0  5     0       0 0.4846428 0 0  0.03295078 -0.02254975  1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(dta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1827    9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dta<span class="sc">$</span>D)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   0    1 
1640  187 </code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Generate the baseline values of <span class="math inline">\(A,L_1,L_2\)</span> (i.e.&nbsp;the values at time 0) so that the baseline values are stored in each row of data for a given individual. We will refer to these as <span class="math inline">\(A_0, L_{10}, L_{20}\)</span>.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>dta<span class="sc">$</span>A0 <span class="ot">=</span> <span class="fu">ave</span>(dta<span class="sc">$</span>A, dta<span class="sc">$</span>id, <span class="at">FUN=</span><span class="cf">function</span>(x){x[<span class="dv">1</span>]})</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>dta<span class="sc">$</span>L10 <span class="ot">=</span> <span class="fu">ave</span>(dta<span class="sc">$</span>L1, dta<span class="sc">$</span>id, <span class="at">FUN=</span><span class="cf">function</span>(x){x[<span class="dv">1</span>]})</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>dta<span class="sc">$</span>L20 <span class="ot">=</span> <span class="fu">ave</span>(dta<span class="sc">$</span>L2, dta<span class="sc">$</span>id, <span class="at">FUN=</span><span class="cf">function</span>(x){x[<span class="dv">1</span>]})</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    id visit T.start   T.stop D A           X         L1 L2 A0        L10 L20
1.0  1     0       0 0.115824 0 0 -0.06264538 -0.8227694  1  0 -0.8227694   1
2.0  2     0       0 1.000000 0 0  0.01836433 -1.7963702  0  0 -1.7963702   0
2.1  2     1       1 2.000000 0 0  0.01836433 -0.4466544  1  0 -1.7963702   0
2.2  2     2       2 2.623483 0 1  0.01836433 -0.3408609  1  0 -1.7963702   0
3.0  3     0       0 1.000000 0 1 -0.08356286  1.4657727  1  1  1.4657727   1
3.1  3     1       1 2.000000 0 1 -0.08356286  1.4894002  1  1  1.4657727   1</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>Perform an unweighted (i.e.&nbsp;unadjusted) Kaplan-Meier analysis by treatment status at baseline, <span class="math inline">\(A_0\)</span>, and plot the estimated survival curves. Here we need to take account of the long format of the data using <code>Surv(T.start,T.stop,D)</code> in <code>survfit</code>. What is the crude association between <span class="math inline">\(A_0\)</span> and survival? Obtain the estimated survival probabilities at time 3.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>km.unwt <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(T.start,T.stop,D)<span class="sc">~</span>A0,<span class="at">data=</span>dta)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km.unwt, <span class="at">xlab=</span><span class="st">"Time"</span>,<span class="at">ylab=</span><span class="st">"Survival probability"</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>,<span class="st">"blue"</span>),<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">conf.int=</span>F,<span class="at">main=</span><span class="st">""</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">"bottomleft"</span>,<span class="fu">c</span>(<span class="st">"Treatment strategy A=0"</span>,<span class="st">"Treatment strategy A=1"</span>),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>,<span class="st">"blue"</span>),<span class="at">lty=</span><span class="dv">1</span>,<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">bty=</span><span class="st">"n"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="time_dep_trts_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#survival probabilities at time 3</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(km.unwt,<span class="at">times=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(T.start, T.stop, D) ~ A0, data = dta)

                A0=0 
        time       n.risk      n.event     survival      std.err lower 95% CI 
      3.0000     112.0000     131.0000       0.6638       0.0268       0.6133 
upper 95% CI 
      0.7184 

                A0=1 
        time       n.risk      n.event     survival      std.err lower 95% CI 
      3.0000      60.0000      56.0000       0.7153       0.0365       0.6472 
upper 95% CI 
      0.7905 </code></pre>
</div>
</div>
<ol start="3" type="1">
<li>In this question we will estimate marginal survival curves under the strategies of setting <span class="math inline">\(A_0=1\)</span> for everyone and setting <span class="math inline">\(A_0=0\)</span> for everyone, denoted <span class="math inline">\(S^{a_0=1}(t)=\mathbb{P}(T^{a_0=1}&gt;t)\)</span> and <span class="math inline">\(S^{a_0=0}(t)=\mathbb{P}(T^{a_0=0}&gt;t)\)</span>.</li>
</ol>
<ol type="a">
<li>Using a logistic regression model, generate inverse probability of treatment weights of the form <span class="math display">\[
iptw=\frac{A_0}{\mathbb{P}(A_{0}=1|X,L_{10},L_{20})}+\frac{(1-A_0)}{\mathbb{P}(A_{0}=0|X,L_{10},L_{20})}
\]</span> The model used to generate the weights should be fitted using only the first row of data for each individual.</li>
<li>Perform a weighted Kaplan-Meier analysis by treatment status at baseline (<span class="math inline">\(A_0\)</span>) using the weights generated in (a).</li>
<li>Plot and interpret the estimated survival curves under the two treatment strategies. Obtain estimates of <span class="math inline">\(S^{a_0=1}(t)\)</span> and <span class="math inline">\(S^{a_0=0}(t)\)</span> for <span class="math inline">\(t=3\)</span>.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Fit the model for treatment at baseline</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>mod.treat <span class="ot">=</span> <span class="fu">glm</span>(A0<span class="sc">~</span>X<span class="sc">+</span>L10<span class="sc">+</span>L20,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>dta[dta<span class="sc">$</span>T.start<span class="sc">==</span><span class="dv">0</span>,],<span class="at">family=</span><span class="st">"binomial"</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">#predicted probability of treatment from the model for each individual</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>pred.treat <span class="ot">=</span> <span class="fu">predict</span>(mod.treat,<span class="at">newdata=</span>dta,<span class="at">type=</span><span class="st">"response"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Obtain the weight for each person</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>dta<span class="sc">$</span>iptw <span class="ot">=</span> (dta<span class="sc">$</span>A0<span class="sc">==</span><span class="dv">1</span>)<span class="sc">/</span>pred.treat<span class="sc">+</span>(dta<span class="sc">$</span>A0<span class="sc">==</span><span class="dv">0</span>)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pred.treat)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Weighted Kaplan-Meier</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>km.wt <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(T.start,T.stop,D)<span class="sc">~</span>A0,<span class="at">data=</span>dta,<span class="at">weights =</span> dta<span class="sc">$</span>iptw)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km.wt, <span class="at">xlab=</span><span class="st">"Time"</span>,<span class="at">ylab=</span><span class="st">"Survival probability"</span>,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>,<span class="st">"blue"</span>),<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">conf.int=</span>F,<span class="at">main=</span><span class="st">""</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">"bottomleft"</span>,<span class="fu">c</span>(<span class="st">"Treatment strategy A0=0"</span>,<span class="st">"Treatment strategy A0=1"</span>),</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>,<span class="st">"blue"</span>),<span class="at">lty=</span><span class="dv">1</span>,<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">bty=</span><span class="st">"n"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="time_dep_trts_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#survival probabilities at time 3</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(km.wt,<span class="at">times=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(T.start, T.stop, D) ~ A0, data = dta, 
    weights = dta$iptw)

                A0=0 
        time       n.risk      n.event     survival      std.err lower 95% CI 
      3.0000     148.2815     250.3064       0.5926       0.0307       0.5355 
upper 95% CI 
      0.6558 

                A0=1 
        time       n.risk      n.event     survival      std.err lower 95% CI 
      3.0000     263.4772     125.6947       0.8025       0.0342       0.7382 
upper 95% CI 
      0.8725 </code></pre>
</div>
</div>
<ol start="4" type="1">
<li>The analysis in question 3 assumes that any censoring in the data is independent of any variables that are also related to the outcome. It turns out that the censoring depends on <span class="math inline">\(X\)</span> and <span class="math inline">\(L_2\)</span>, which are also related to the outcome (we know this because we generated the data!). In this question we will account for dependent censoring using inverse probability of censoring weights (IPCW) to estimate <span class="math inline">\(S^{a_0=1,\bar{c}_t=0}(t)=\mathbb{P}(T^{a_0=1,\bar{c}_t=0}&gt;t)\)</span> and <span class="math inline">\(S^{a_0=0,\bar{c}_t=0}(t)=\mathbb{P}(T^{a_0=0,\bar{c}_t=0}&gt;t)\)</span>.</li>
</ol>
<ol type="a">
<li>Generate an indicator for non-administrative censoring in each row for each individual. This should indicate whether the individual is (non-administratively) censored at time <code>T.stop</code>.</li>
<li>Fit a logistic regression model with your censoring indicator as the outcome and with <span class="math inline">\(A, X,L_1,L_2\)</span> as covariates. Include visit as a factor variable.</li>
<li>Use the model in (b) to estimate the inverse probability of censoring weight in each row: <span class="math display">\[
ipcw(t)=\prod_{k=1}^{t}\frac{1}{\mathbb{P}(C_k=0|\bar C_{k-1}=0,\bar{A}_k,X,\bar{L}_{1k},\bar{L}_{2k})}, \quad t=1,2,3
\]</span></li>
<li>Generate a combined weight by multiplying the IPTW by the IPCW, and perform a weighted Kaplan-Meier analysis by treatment status at baseline (<span class="math inline">\(A_0\)</span>).</li>
<li>Plot and interpret the estimated survival curves under the two treatment strategies. Obtain estimates of <span class="math inline">\(S^{a_0=1,\bar{c}_t=0}(t)\)</span> and <span class="math inline">\(S^{a_0=1,\bar{c}_t=0}(t)\)</span> for <span class="math inline">\(t=3\)</span>.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create event variable for censoring</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>dta<span class="sc">$</span>censored <span class="ot">=</span> <span class="fu">ave</span>(dta<span class="sc">$</span>D, dta<span class="sc">$</span>id, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(<span class="fu">cumsum</span>(x)<span class="sc">==</span><span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(x)), <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(x)<span class="sc">-</span><span class="dv">1</span>), <span class="dv">1</span>), <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(x)))})</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>dta<span class="sc">$</span>censored <span class="ot">=</span> <span class="fu">ifelse</span>(dta<span class="sc">$</span>T.stop<span class="sc">==</span><span class="dv">3</span> <span class="sc">&amp;</span> dta<span class="sc">$</span>D<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,dta<span class="sc">$</span>censored) </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit pooled logistic regressions with censoring as outcome:</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>cwfit.denum <span class="ot">=</span> <span class="fu">glm</span>(censored <span class="sc">~</span> <span class="fu">as.factor</span>(T.start) <span class="sc">+</span> A <span class="sc">+</span> X <span class="sc">+</span> L1 <span class="sc">+</span> L2, </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">family=</span>binomial, <span class="at">data=</span>dta)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict individual censoring probabilities over time:</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>cprob.denum <span class="ot">=</span> <span class="fu">predict</span>(cwfit.denum, dta, <span class="at">type=</span><span class="st">"response"</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate IPCW's:</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>dta<span class="sc">$</span>ipcw <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>cprob.denum)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>dta<span class="sc">$</span>ipcw <span class="ot">=</span> <span class="fu">ave</span>(dta<span class="sc">$</span>ipcw, dta<span class="sc">$</span>id, <span class="at">FUN =</span> cumprod)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">#combined weights</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>dta<span class="sc">$</span>comb.wt <span class="ot">=</span> <span class="fu">pmin</span>(dta<span class="sc">$</span>ipcw<span class="sc">*</span>dta<span class="sc">$</span>iptw,<span class="dv">50</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>dta<span class="sc">$</span>comb.wt <span class="ot">=</span> <span class="fu">pmin</span>(dta<span class="sc">$</span>ipcw<span class="sc">*</span>dta<span class="sc">$</span>iptw,<span class="dv">50</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co">#Weighted Kaplan-Meier</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>km.wt2 <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(T.start,T.stop,D)<span class="sc">~</span>A0,<span class="at">data=</span>dta,<span class="at">weights =</span> dta<span class="sc">$</span>comb.wt)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km.wt2, <span class="at">xlab=</span><span class="st">"Time"</span>,<span class="at">ylab=</span><span class="st">"Survival probability"</span>,</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>,<span class="st">"blue"</span>),<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">conf.int=</span>F,<span class="at">main=</span><span class="st">""</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">"bottomleft"</span>,<span class="fu">c</span>(<span class="st">"Treatment strategy A0=0"</span>,<span class="st">"Treatment strategy A0=1"</span>),</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>,<span class="st">"blue"</span>),<span class="at">lty=</span><span class="dv">1</span>,<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">bty=</span><span class="st">"n"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="time_dep_trts_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#survival probabilities at time 3</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(km.wt2,<span class="at">times=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(T.start, T.stop, D) ~ A0, data = dta, 
    weights = dta$comb.wt)

                A0=0 
        time       n.risk      n.event     survival      std.err lower 95% CI 
      3.0000     482.1156     631.2879       0.5132       0.0439       0.4340 
upper 95% CI 
      0.6068 

                A0=1 
        time       n.risk      n.event     survival      std.err lower 95% CI 
      3.0000     565.6242     338.5842       0.7377       0.0455       0.6538 
upper 95% CI 
      0.8324 </code></pre>
</div>
</div>
<ol start="5" type="1">
<li>EXTRA. The analysis in question 4 assumes that censoring only occurs at time 1, 2, or 3. The censoring times can actually be at any time (in this data set). One approach to allowing for this is to extend the analysis in 4 to allow censoring times to occur on a small grid of times, say <span class="math inline">\(0.1,0.2,\ldots,2.9,3.0\)</span>. To allow this the first step is to divide each individualâ€™s follow-up into smaller time periods according to the grid <span class="math inline">\(0.1,0.2,\ldots,2.9,3.0\)</span>, which can be done using the <code>survSplit</code> function: <code>dta.split = survSplit(Surv(T.start,T.stop,D)~.,data=dta,cut=seq(0,3,0.1))</code>. The rest of the analysis then follows as above, except that in the censoring weights model we recommend including a spline term for <code>T.start</code> instead of the separate indicator for each time (e.g.&nbsp;<code>ns(T.start,df=4)</code>).</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dta.split <span class="ot">=</span> <span class="fu">survSplit</span>(<span class="fu">Surv</span>(T.start,T.stop,D)<span class="sc">~</span>.,<span class="at">data=</span>dta,<span class="at">cut=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">3</span>,<span class="fl">0.1</span>))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new event variable for censoring</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>dta.split<span class="sc">$</span>censored  <span class="ot">=</span>  <span class="fu">ave</span>(dta.split<span class="sc">$</span>D, dta.split<span class="sc">$</span>id, <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(<span class="fu">cumsum</span>(x)<span class="sc">==</span><span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(x)), <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(x)<span class="sc">-</span><span class="dv">1</span>), <span class="dv">1</span>), <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(x)))})</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>dta.split<span class="sc">$</span>censored  <span class="ot">=</span> <span class="fu">ifelse</span>(dta.split<span class="sc">$</span>T.stop<span class="sc">==</span><span class="dv">3</span> <span class="sc">&amp;</span> dta.split<span class="sc">$</span>D<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,dta.split<span class="sc">$</span>censored) </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit pooled logistic regressions with censoring as outcome</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>cwfit.denum <span class="ot">=</span> <span class="fu">glm</span>(censored <span class="sc">~</span> splines<span class="sc">::</span><span class="fu">ns</span>(T.start,<span class="at">df=</span><span class="dv">4</span>) <span class="sc">+</span> A <span class="sc">+</span> X <span class="sc">+</span> L1 <span class="sc">+</span> L2, </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">family=</span>binomial, <span class="at">data=</span>dta.split)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict individual censoring probabilities over time:</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>cprob.denum <span class="ot">=</span> <span class="fu">predict</span>(cwfit.denum, dta.split, <span class="at">type=</span><span class="st">"response"</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate IPCW's</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>dta.split<span class="sc">$</span>ipcw <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>cprob.denum)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>dta.split<span class="sc">$</span>ipcw <span class="ot">=</span> <span class="fu">ave</span>(dta.split<span class="sc">$</span>ipcw, dta.split<span class="sc">$</span>id, <span class="at">FUN =</span> cumprod)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">#combined weights</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>dta.split<span class="sc">$</span>comb.wt <span class="ot">=</span> dta.split<span class="sc">$</span>ipcw<span class="sc">*</span>dta.split<span class="sc">$</span>iptw</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">#Weighted Kaplan-Meier</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>km.wt3 <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(T.start,T.stop,D)<span class="sc">~</span>A0,<span class="at">data=</span>dta.split,<span class="at">weights =</span> dta.split<span class="sc">$</span>comb.wt)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km.wt3, <span class="at">xlab=</span><span class="st">"Time"</span>,<span class="at">ylab=</span><span class="st">"Survival probability"</span>,</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>,<span class="st">"blue"</span>),<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">conf.int=</span>F,<span class="at">main=</span><span class="st">""</span>)</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">"bottomleft"</span>,<span class="fu">c</span>(<span class="st">"Treatment strategy A0=0"</span>,<span class="st">"Treatment strategy A0=1"</span>),</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>,<span class="st">"blue"</span>),<span class="at">lty=</span><span class="dv">1</span>,<span class="at">lwd=</span><span class="dv">2</span>,<span class="at">bty=</span><span class="st">"n"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="time_dep_trts_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#survival probabilities at time 3</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(km.wt3,<span class="at">times=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(T.start, T.stop, D) ~ A0, data = dta.split, 
    weights = dta.split$comb.wt)

                A0=0 
        time       n.risk      n.event     survival      std.err lower 95% CI 
       3.000      625.308      554.926        0.482        0.058        0.380 
upper 95% CI 
       0.610 

                A0=1 
        time       n.risk      n.event     survival      std.err lower 95% CI 
       3.000      640.274      283.014        0.727        0.049        0.637 
upper 95% CI 
       0.830 </code></pre>
</div>
</div>
</section>
<section id="sustained-treatment-strategies-and-the-cloning-censoring-weighting-approach" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="sustained-treatment-strategies-and-the-cloning-censoring-weighting-approach">Sustained treatment strategies and the cloning-censoring-weighting approach</h2>
<p>The aim in this part is to estimate survival curves if everyone had received treatment <span class="math inline">\(A\)</span> from time 0 onwards (<span class="math inline">\(a_0=a_1=a_2=1\)</span>) and if everyone had not received treatment <span class="math inline">\(A\)</span> from time 0 onwards (<span class="math inline">\(a_0=a_1=a_2=0\)</span>). The estimands are denoted <span class="math inline">\(S^{\underline{a}_0=1}(t)=\mathbb{P}(T^{\underline{a}_0=1}&gt;t)\)</span> and <span class="math inline">\(S^{\underline{a}_0=0}(t)=\mathbb{P}(T^{\underline{a}_0=0}&gt;t)\)</span>. The questions below take us through the steps required to perform the cloning-censoring-weighting analysis.</p>
<ol type="1">
<li>In this first question we will perform the <em>cloning</em> step and generate some variables needed for subsequent data manipulation and analysis.</li>
</ol>
<ol type="a">
<li>Create two copies of the data, one corresponding to each of the two treatment strategies of interest. Denote these <code>clone.1</code> (for strategy <span class="math inline">\(a_0=a_1=a_2=1\)</span>) and <code>clone.0</code> (for strategy <span class="math inline">\(a_0=a_1=a_2=0\)</span>).</li>
<li>In the <code>clone.1</code> data generate a new variable indicating whether a person has deviated from the strategy <span class="math inline">\(a_0=a_1=a_2=1\)</span>. Note that some individuals deviate from this strategy immediately because they have <span class="math inline">\(A_0=0\)</span> in their first row. Keep all rows of data up to and including the <em>deviation row</em> in which the person first deviates from the strategy <span class="math inline">\(a_0=a_1=a_2=1\)</span>, and discard rows after that in which the person has first deviated. Later we will drop the <em>deviation row</em>, but we need to keep it for now in order to estimate the artificial censoring weights (question 2!).</li>
<li>Repeat (b) for the <code>clone.0</code> data, thinking now of the strategy <span class="math inline">\(a_0=a_1=a_2=0\)</span>.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Create two copies of the data</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span> <span class="ot">=</span> dta</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span> <span class="ot">=</span> dta</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">#---</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">#For clone.1</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">#cumulative sum of treatment status being A=1</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>cumsumA <span class="ot">=</span> <span class="fu">ave</span>(clone<span class="fl">.1</span><span class="sc">$</span>A<span class="sc">==</span><span class="dv">1</span>,clone<span class="fl">.1</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumsum)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">#indicator of whether the person has deviated from A=1</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>switchA <span class="ot">=</span> <span class="fu">ifelse</span>(clone<span class="fl">.1</span><span class="sc">$</span>cumsumA<span class="sc">==</span>clone<span class="fl">.1</span><span class="sc">$</span>T.start<span class="sc">+</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">#cumulative indicator of whether the person has deviated from A=1</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>switchA <span class="ot">=</span> <span class="fu">ave</span>(clone<span class="fl">.1</span><span class="sc">$</span>switchA,clone<span class="fl">.1</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumsum)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co">#drop if switchA&gt;1 </span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co">#because we are only going to use the rows where switchA=0 or 1 to estimate the weights.</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span> <span class="ot">=</span> clone<span class="fl">.1</span>[clone<span class="fl">.1</span><span class="sc">$</span>switchA<span class="sc">&lt;=</span><span class="dv">1</span>,]</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co">#---</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="co">#For clone.0</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="co">#cumulative sum of treatment status being A=0</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>cumsumA <span class="ot">=</span> <span class="fu">ave</span>(clone<span class="fl">.0</span><span class="sc">$</span>A<span class="sc">==</span><span class="dv">0</span>,clone<span class="fl">.0</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumsum)</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co">#indicator of whether the person has deviated from A=0</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>switchA <span class="ot">=</span> <span class="fu">ifelse</span>(clone<span class="fl">.0</span><span class="sc">$</span>cumsumA<span class="sc">==</span>clone<span class="fl">.0</span><span class="sc">$</span>T.start<span class="sc">+</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="co">#cumulative indicator of whether the person has deviated from A=0</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>switchA <span class="ot">=</span> <span class="fu">ave</span>(clone<span class="fl">.0</span><span class="sc">$</span>switchA,clone<span class="fl">.0</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumsum)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="co">#drop if cumsum.switchA&gt;1 </span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="co">#because we are only going to use the rows where switchA=0 or 1 to estimate the weights.</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span> <span class="ot">=</span> clone<span class="fl">.0</span>[clone<span class="fl">.0</span><span class="sc">$</span>switchA<span class="sc">&lt;=</span><span class="dv">1</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>In question 1 we have generated a variable <code>switchA</code> which is <code>switchA=0</code> in rows in which the individual is following the treatment strategy of interest, and which is <code>switchA=1</code> in the first row in which the person has deviated from the strategy (rows after this have been excluded). Next we will use this variable to estimate the <em>artificial censoring weights</em>. Consider first the data set <code>clone.1</code> and use the following steps:</li>
</ol>
<ol type="a">
<li>Fit a logistic regression model with <code>switchA</code> as the outcome and with covariates the variables <span class="math inline">\(X,L_{2},L_{1}\)</span> from the same row, plus an indicator for <code>T.start</code>. This model can be fitted using all rows combined.</li>
<li>Drop the rows in which <code>switchA=1</code>. we are now finished with this variable.</li>
<li>Use the model in (a) to obtain the artificial censoring weights. The weight in a given row is the probability that a person remains uncensored (i.e.&nbsp;that they have not switched from the treatment strategy of interest): <span class="math display">\[
W(t)=\prod_{k=0}^{t}\frac{1}{\mathbb{P}(switchA_k=0|X,L_{2k},L_{1k})},\quad t=0,1,2
\]</span></li>
<li>Repeat steps (a)-(c) for the data set <code>clone.0</code>.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#weights models</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>wt.mod.denom<span class="fl">.1</span><span class="ot">=</span><span class="fu">glm</span>(switchA<span class="sc">~</span><span class="fu">as.factor</span>(T.start)<span class="sc">+</span>X<span class="sc">+</span>L1<span class="sc">+</span>L2,<span class="at">family=</span><span class="st">"binomial"</span>,<span class="at">data=</span>clone<span class="fl">.1</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>wt.denom <span class="ot">=</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">predict</span>(wt.mod.denom<span class="fl">.1</span>,<span class="at">type =</span> <span class="st">"response"</span>,<span class="at">newdata =</span> clone<span class="fl">.1</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>wt.mod.denom<span class="fl">.0</span><span class="ot">=</span><span class="fu">glm</span>(switchA<span class="sc">~</span><span class="fu">as.factor</span>(T.start)<span class="sc">+</span>X<span class="sc">+</span>L1<span class="sc">+</span>L2,<span class="at">family=</span><span class="st">"binomial"</span>,<span class="at">data=</span>clone<span class="fl">.0</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>wt.denom <span class="ot">=</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">predict</span>(wt.mod.denom<span class="fl">.0</span>,<span class="at">type =</span> <span class="st">"response"</span>,<span class="at">newdata =</span> clone<span class="fl">.0</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">#drop the row where the switch occurred</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span> <span class="ot">=</span> clone<span class="fl">.1</span>[clone<span class="fl">.1</span><span class="sc">$</span>switchA<span class="sc">==</span><span class="dv">0</span>,]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span> <span class="ot">=</span> clone<span class="fl">.0</span>[clone<span class="fl">.0</span><span class="sc">$</span>switchA<span class="sc">==</span><span class="dv">0</span>,]</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co">#ipcw for the artificial censoring</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>wt <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>clone<span class="fl">.1</span><span class="sc">$</span>wt.denom</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>wt <span class="ot">=</span> <span class="fu">ave</span>(clone<span class="fl">.1</span><span class="sc">$</span>wt,clone<span class="fl">.1</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumprod)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>wt <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>clone<span class="fl">.0</span><span class="sc">$</span>wt.denom</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>wt <span class="ot">=</span> <span class="fu">ave</span>(clone<span class="fl">.0</span><span class="sc">$</span>wt,clone<span class="fl">.0</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumprod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>Finally, we perform the <em>weighting</em> step of the cloning-censoring-weighting approach, by performing a weighted analysis using the weights generated in question 2.</li>
</ol>
<ol type="a">
<li>Using the data set <code>clone.1</code> perform a weighted Kaplan-Meier analysis to estimate <span class="math display">\[S^{\underline{a}_0=1}(t)=\mathbb{P}(T^{\underline{a}_0=1}&gt;t)\]</span></li>
<li>Using the data set <code>clone.0</code> perform a weighted Kaplan-Meier analysis to estimate <span class="math display">\[S^{\underline{a}_0=0}(t)=\mathbb{P}(T^{\underline{a}_0=0}&gt;t)\]</span></li>
<li>Compare the estimated survival curves in a plot and interpret the results.</li>
<li>Obtain the estimated survival probability at time 3 under each treatment strategy, and the corresponding risk difference</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>km<span class="fl">.1</span> <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(T.start,T.stop,D)<span class="sc">~</span><span class="dv">1</span>,<span class="at">data=</span>clone<span class="fl">.1</span>,<span class="at">weights =</span> clone<span class="fl">.1</span><span class="sc">$</span>wt)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>km<span class="fl">.0</span> <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(T.start,T.stop,D)<span class="sc">~</span><span class="dv">1</span>,<span class="at">data=</span>clone<span class="fl">.0</span>,<span class="at">weights =</span> clone<span class="fl">.0</span><span class="sc">$</span>wt)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km<span class="fl">.1</span><span class="sc">$</span>time,km<span class="fl">.1</span><span class="sc">$</span>surv,<span class="at">type=</span><span class="st">"s"</span>,<span class="at">col=</span><span class="st">"blue"</span>,<span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Time"</span>,<span class="at">ylab=</span><span class="st">"Survival probability"</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(km<span class="fl">.0</span><span class="sc">$</span>time,km<span class="fl">.0</span><span class="sc">$</span>surv,<span class="at">type=</span><span class="st">"s"</span>,<span class="at">col=</span><span class="st">"red"</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>,<span class="fu">c</span>(<span class="st">"Sustained A=1"</span>,<span class="st">"Sustained A=0"</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">"blue"</span>,<span class="st">"red"</span>),<span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="time_dep_trts_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#survival probabilities and risk difference at time 3</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(km<span class="fl">.1</span>,<span class="at">times=</span><span class="dv">3</span>)<span class="sc">$</span>surv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8078718</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(km<span class="fl">.0</span>,<span class="at">times=</span><span class="dv">3</span>)<span class="sc">$</span>surv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4359687</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span><span class="sc">-</span><span class="fu">summary</span>(km<span class="fl">.1</span>,<span class="at">times=</span><span class="dv">3</span>)<span class="sc">$</span>surv)<span class="sc">-</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">summary</span>(km<span class="fl">.0</span>,<span class="at">times=</span><span class="dv">3</span>)<span class="sc">$</span>surv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.3719031</code></pre>
</div>
</div>
<ol start="4" type="1">
<li>EXTRA. The above cloning-censoring-weighting analysis does not account for any standard censoring that may depend on covariates. This can be done by combining the censoring weights estimated in Part A, with the cloning-censoring-weighting approach performed in Part B. We recommend estimating the standard censoring weights first.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Demonstrated here by starting from dta.split, </span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># which contains the ipcw for standard censoring.</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Create two copies of the data</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span> <span class="ot">=</span> dta.split</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span> <span class="ot">=</span> dta.split</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">#---</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">#For clone.1</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co">#cumulative sum of treatment status being A=1</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>cumsumA <span class="ot">=</span> <span class="fu">ave</span>(clone<span class="fl">.1</span><span class="sc">$</span>A<span class="sc">==</span><span class="dv">1</span>,clone<span class="fl">.1</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumsum)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">#indicator of whether the person has deviated from A=1</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>rownum<span class="ot">=</span><span class="fu">ave</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">dim</span>(clone<span class="fl">.1</span>)[<span class="dv">1</span>]),clone<span class="fl">.1</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumsum)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>switchA <span class="ot">=</span> <span class="fu">ifelse</span>(clone<span class="fl">.1</span><span class="sc">$</span>cumsumA<span class="sc">==</span>clone<span class="fl">.1</span><span class="sc">$</span>rownum,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co">#cumulative indicator of whether the person has deviated from A=1</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>switchA <span class="ot">=</span> <span class="fu">ave</span>(clone<span class="fl">.1</span><span class="sc">$</span>switchA,clone<span class="fl">.1</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumsum)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="co">#drop if switchA&gt;1 </span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="co">#because we are only going to use the rows where switchA=0 or 1 to estimate the weights.</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span> <span class="ot">=</span> clone<span class="fl">.1</span>[clone<span class="fl">.1</span><span class="sc">$</span>switchA<span class="sc">&lt;=</span><span class="dv">1</span>,]</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="co">#---</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="co">#For clone.0</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="co">#cumulative sum of treatment status being A=0</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>cumsumA <span class="ot">=</span> <span class="fu">ave</span>(clone<span class="fl">.0</span><span class="sc">$</span>A<span class="sc">==</span><span class="dv">0</span>,clone<span class="fl">.0</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumsum)</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="co">#indicator of whether the person has deviated from A=0</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>rownum<span class="ot">=</span><span class="fu">ave</span>(<span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">dim</span>(clone<span class="fl">.0</span>)[<span class="dv">1</span>]),clone<span class="fl">.0</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumsum)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>switchA <span class="ot">=</span> <span class="fu">ifelse</span>(clone<span class="fl">.0</span><span class="sc">$</span>cumsumA<span class="sc">==</span>clone<span class="fl">.0</span><span class="sc">$</span>rownum,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="co">#cumulative indicator of whether the person has deviated from A=0</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>switchA <span class="ot">=</span> <span class="fu">ave</span>(clone<span class="fl">.0</span><span class="sc">$</span>switchA,clone<span class="fl">.0</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumsum)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="co">#drop if cumsum.switchA&gt;1 </span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="co">#because we are only going to use the rows where switchA=0 or 1 to estimate the weights.</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span> <span class="ot">=</span> clone<span class="fl">.0</span>[clone<span class="fl">.0</span><span class="sc">$</span>switchA<span class="sc">&lt;=</span><span class="dv">1</span>,]</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="co">#weights models</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>wt.mod.denom<span class="fl">.1</span><span class="ot">=</span><span class="fu">glm</span>(switchA<span class="sc">~</span><span class="fu">as.factor</span>(visit)<span class="sc">+</span>X<span class="sc">+</span>L1<span class="sc">+</span>L2,<span class="at">family=</span><span class="st">"binomial"</span>,</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data=</span>clone<span class="fl">.1</span>[clone<span class="fl">.1</span><span class="sc">$</span>T.start<span class="sc">%in%</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>),])</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>wt.denom <span class="ot">=</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">predict</span>(wt.mod.denom<span class="fl">.1</span>,<span class="at">type =</span> <span class="st">"response"</span>,<span class="at">newdata =</span> clone<span class="fl">.1</span>)</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>wt.mod.denom<span class="fl">.0</span><span class="ot">=</span><span class="fu">glm</span>(switchA<span class="sc">~</span><span class="fu">as.factor</span>(visit)<span class="sc">+</span>X<span class="sc">+</span>L1<span class="sc">+</span>L2,<span class="at">family=</span><span class="st">"binomial"</span>,</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data=</span>clone<span class="fl">.0</span>[clone<span class="fl">.0</span><span class="sc">$</span>T.start<span class="sc">%in%</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>),])</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>wt.denom <span class="ot">=</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">predict</span>(wt.mod.denom<span class="fl">.0</span>,<span class="at">type =</span> <span class="st">"response"</span>,<span class="at">newdata =</span> clone<span class="fl">.0</span>)</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a><span class="co">#drop the row where the switch occurred</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span> <span class="ot">=</span> clone<span class="fl">.1</span>[clone<span class="fl">.1</span><span class="sc">$</span>switchA<span class="sc">==</span><span class="dv">0</span>,]</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span> <span class="ot">=</span> clone<span class="fl">.0</span>[clone<span class="fl">.0</span><span class="sc">$</span>switchA<span class="sc">==</span><span class="dv">0</span>,]</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a><span class="co">#ipcw for the artificial censoring</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>wt <span class="ot">=</span> <span class="fu">ifelse</span>(clone<span class="fl">.1</span><span class="sc">$</span>T.start<span class="sc">%in%</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>),<span class="dv">1</span><span class="sc">/</span>clone<span class="fl">.1</span><span class="sc">$</span>wt.denom,<span class="dv">1</span>)</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>wt <span class="ot">=</span> <span class="fu">ave</span>(clone<span class="fl">.1</span><span class="sc">$</span>wt,clone<span class="fl">.1</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumprod)</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>wt <span class="ot">=</span> <span class="fu">ifelse</span>(clone<span class="fl">.0</span><span class="sc">$</span>T.start<span class="sc">%in%</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>),<span class="dv">1</span><span class="sc">/</span>clone<span class="fl">.0</span><span class="sc">$</span>wt.denom,<span class="dv">1</span>)</span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>wt <span class="ot">=</span> <span class="fu">ave</span>(clone<span class="fl">.0</span><span class="sc">$</span>wt,clone<span class="fl">.0</span><span class="sc">$</span>id,<span class="at">FUN=</span>cumprod)</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a><span class="co">#combine the artificial censoring weight with the standard censoring weight</span></span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.1</span><span class="sc">$</span>comb.wt <span class="ot">=</span> clone<span class="fl">.1</span><span class="sc">$</span>wt<span class="sc">*</span>clone<span class="fl">.1</span><span class="sc">$</span>ipcw</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>clone<span class="fl">.0</span><span class="sc">$</span>comb.wt <span class="ot">=</span> clone<span class="fl">.0</span><span class="sc">$</span>wt<span class="sc">*</span>clone<span class="fl">.0</span><span class="sc">$</span>ipcw</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a><span class="co">#weighted Kaplan-Meier analyses</span></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a><span class="co">#Note that if we use wt instead of comb.wt then the results are </span></span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a><span class="co"># identical to those in question 4, as they should be</span></span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>km<span class="fl">.1</span> <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(T.start,T.stop,D)<span class="sc">~</span><span class="dv">1</span>,<span class="at">data=</span>clone<span class="fl">.1</span>,<span class="at">weights =</span> clone<span class="fl">.1</span><span class="sc">$</span>comb.wt)</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>km<span class="fl">.0</span> <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(T.start,T.stop,D)<span class="sc">~</span><span class="dv">1</span>,<span class="at">data=</span>clone<span class="fl">.0</span>,<span class="at">weights =</span> clone<span class="fl">.0</span><span class="sc">$</span>comb.wt)</span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(km<span class="fl">.1</span><span class="sc">$</span>time,km<span class="fl">.1</span><span class="sc">$</span>surv,<span class="at">type=</span><span class="st">"s"</span>,<span class="at">col=</span><span class="st">"blue"</span>,<span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Time"</span>,<span class="at">ylab=</span><span class="st">"Survival probability"</span>,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(km<span class="fl">.0</span><span class="sc">$</span>time,km<span class="fl">.0</span><span class="sc">$</span>surv,<span class="at">type=</span><span class="st">"s"</span>,<span class="at">col=</span><span class="st">"red"</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>,<span class="fu">c</span>(<span class="st">"Sustained A=1"</span>,<span class="st">"Sustained A=0"</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">"blue"</span>,<span class="st">"red"</span>),<span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="time_dep_trts_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#survival probabilities and risk difference at time 3</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(km<span class="fl">.1</span>,<span class="at">times=</span><span class="dv">3</span>)<span class="sc">$</span>surv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7254016</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(km<span class="fl">.0</span>,<span class="at">times=</span><span class="dv">3</span>)<span class="sc">$</span>surv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2601855</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span><span class="sc">-</span><span class="fu">summary</span>(km<span class="fl">.1</span>,<span class="at">times=</span><span class="dv">3</span>)<span class="sc">$</span>surv)<span class="sc">-</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">summary</span>(km<span class="fl">.0</span>,<span class="at">times=</span><span class="dv">3</span>)<span class="sc">$</span>surv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.4652161</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="./point_trts.html" class="pagination-link" aria-label="Weighting and standardisation for point treatments">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Weighting and standardisation for point treatments</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./sustained_trts.html" class="pagination-link" aria-label="Marginal structural models and g-formula for sustained treatment strategies">
        <span class="nav-page-text">Marginal structural models and g-formula for sustained treatment strategies</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>