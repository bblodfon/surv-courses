<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Various code examples and methodologies for survival analysis">

<title>Estimating causal effects on time-to-event outcomes under competing risks – Material on Survival Analyses</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./sustained_trts.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./causal_comp_risk.html">Estimating causal effects on time-to-event outcomes under competing risks</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Material on Survival Analyses</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/bblodfon/surv-courses/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./na_km_logrank.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Non-parametric estimators</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cox_regr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cox Regression (low-dim)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cox_regr_high_dim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cox regression (high-dim)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./aalen.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Additive regression</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mstate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multi-state models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./frailty.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Frailty models for clustered data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ncc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Case-control studies</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./point_trts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Weighting and standardisation for point treatments</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./time_dep_trts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Censoring and time-dependent treatment strategies</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sustained_trts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Marginal structural models and g-formula for sustained treatment strategies</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./causal_comp_risk.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Estimating causal effects on time-to-event outcomes under competing risks</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#data" id="toc-data" class="nav-link active" data-scroll-target="#data">Data</a></li>
  <li><a href="#aims" id="toc-aims" class="nav-link" data-scroll-target="#aims">Aims</a></li>
  <li><a href="#load-data-and-packages" id="toc-load-data-and-packages" class="nav-link" data-scroll-target="#load-data-and-packages">Load data and packages</a></li>
  <li><a href="#simple-analyses-using-a-composite-endpoint" id="toc-simple-analyses-using-a-composite-endpoint" class="nav-link" data-scroll-target="#simple-analyses-using-a-composite-endpoint">Simple analyses using a composite endpoint</a></li>
  <li><a href="#estimating-cause-specific-cumulative-incidence-using-ipw" id="toc-estimating-cause-specific-cumulative-incidence-using-ipw" class="nav-link" data-scroll-target="#estimating-cause-specific-cumulative-incidence-using-ipw">Estimating cause-specific cumulative incidence using IPW</a></li>
  <li><a href="#estimating-cause-specific-cumulative-incidence-using-standardisation-g-formula" id="toc-estimating-cause-specific-cumulative-incidence-using-standardisation-g-formula" class="nav-link" data-scroll-target="#estimating-cause-specific-cumulative-incidence-using-standardisation-g-formula">Estimating cause-specific cumulative incidence using standardisation (g-formula)</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Estimating causal effects on time-to-event outcomes under competing risks</h1>
</div>



<div class="quarto-title-meta column-body">

    
  
    
  </div>
  


</header>


<section id="data" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="data">Data</h2>
<p>In this practical we return to the ‘rotterdam’ data set, which includes data on individuals who underwent surgery for primary breast cancer between 1978 and 1993, and whose data were recorded in the Rotterdam Tumour Bank. The data include information on treatments received alongside a number of individual characteristics. Individuals were followed up for disease recurrence and death for up to a maximum of 19.3 years. This data set is available as part of the ‘survival’ package in R, and it has been widely used to illustrate survival analysis methods [e.g.&nbsp;see Royston P, Altman D. External validation of a Cox prognostic model: principles and methods. BMC Medical Research Methodology 2013, 13:33].</p>
<p>We will again consider the slightly modified version of the Rotterdam data set in which individual follow-up is recorded in years instead of days, and where we have applied censoring at 10 years. We have also created an additional variable ‘enodes’ which is a transformation of the nodes variable - this transformation has been used in several previous analyses of these data. Some individuals in the original data set have been excluded, as they had recorded death times after they were censored for recurrence, resulting in a final sample size of 2939 individuals.</p>
<p><img src="img/dta_vars.png" class="img-fluid"></p>
</section>
<section id="aims" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="aims">Aims</h2>
<p>The aim is now to estimate the effect of hormone therapy use on time to the first event to occur, of recurrence and death, up to 10 years. As before, we will estimate the population average (marginal) outcomes we would expect if everyone had received hormone therapy (<code>hormon = 1</code>) and if everyone had not received hormone therapy (<code>hormon = 0</code>) using IPTW weighting and standardisation (g-formula), but this time we will focus on estimation on outcomes under competing risk.</p>
</section>
<section id="load-data-and-packages" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="load-data-and-packages">Load data and packages</h2>
<p>As before, load the data and let the treatment variable (<code>hormon</code>) be a factor variable.</p>
<p>In this practical we will only use the survival and boot packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>dta <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"data/dta.rds"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>dta<span class="sc">$</span>hormon <span class="ot">=</span> <span class="fu">as.factor</span>(dta<span class="sc">$</span>hormon)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simple-analyses-using-a-composite-endpoint" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="simple-analyses-using-a-composite-endpoint">Simple analyses using a composite endpoint</h2>
<ol type="1">
<li>Obtain and plot un-adjusted Kaplan-Meier survival curves for time to the composite event of recurrence or death, for people who did and did not receive hormone therapy. How does the result compare to the result you got when looking at time to death only? How do you interpret any differences?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and plot K-M for time to composite endpoint:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>kmc <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(rdtime, rd <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> hormon, <span class="at">data=</span>dta)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(kmc, <span class="at">xlab=</span><span class="st">"Time (years)"</span>, <span class="at">ylab=</span><span class="st">"Survival probability"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">conf.int=</span>T)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">"bottomleft"</span>, <span class="fu">c</span>(<span class="st">"Treatment: No"</span>, <span class="st">"Treatment: Yes"</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty=</span><span class="dv">1</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">bty=</span><span class="st">"n"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add grey lines for K-M for time to death only:</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>km <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(dtime, death) <span class="sc">~</span> hormon, <span class="at">data=</span>dta)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(km, <span class="at">col=</span><span class="fu">c</span>(<span class="st">"gray"</span>,<span class="st">"lightgray"</span>), <span class="at">conf.int=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_comp_risk_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol start="2" type="1">
<li>Now estimate and plot adjusted marginal survival curves for the composite endpoints using the same inverse probability of treatment weights as you made in Exercise 1. Interpret your results.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model for treatment:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>mod.treat <span class="ot">=</span> <span class="fu">glm</span>(hormon <span class="sc">~</span> age <span class="sc">+</span> meno <span class="sc">+</span> size <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>(grade) <span class="sc">+</span> enodes <span class="sc">+</span> pgr <span class="sc">+</span> er <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    chemo, <span class="at">data=</span>dta, <span class="at">family=</span><span class="st">"binomial"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict the probability of treatment for each individual:</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>pred.treat <span class="ot">=</span> <span class="fu">predict</span>(mod.treat, <span class="at">data=</span>dta, <span class="at">type=</span><span class="st">"response"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain the weight for each person:</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>dta<span class="sc">$</span>wt <span class="ot">=</span> (dta<span class="sc">$</span>hormon<span class="sc">==</span><span class="dv">1</span>)<span class="sc">/</span>pred.treat <span class="sc">+</span> (dta<span class="sc">$</span>hormon<span class="sc">==</span><span class="dv">0</span>)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pred.treat)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and plot weighted K-M for time to composite endpoint:</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>kmc.wt <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(rdtime, rd <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> hormon, <span class="at">weights=</span>wt, <span class="at">data=</span>dta)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(kmc.wt, <span class="at">xlab=</span><span class="st">"Time (years)"</span>, <span class="at">ylab=</span><span class="st">"Survival probability"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">"bottomleft"</span>, <span class="fu">c</span>(<span class="st">"Treatment: No"</span>, <span class="st">"Treatment: Yes"</span>),</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty=</span><span class="dv">1</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">bty=</span><span class="st">"n"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_comp_risk_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol start="3" type="1">
<li>Run a test for the difference between composite “survival” curves and interpret the results.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(rdtime, rd <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> hormon, <span class="at">weights=</span>wt, <span class="at">data=</span>dta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(rdtime, rd != 0) ~ hormon, data = dta, weights = wt)

           coef exp(coef) se(coef) robust se      z     p
hormon1 -0.2258    0.7979   0.0362    0.1437 -1.571 0.116

Likelihood ratio test=39.05  on 1 df, p=4.137e-10
n= 2939, number of events= 1612 </code></pre>
</div>
</div>
</section>
<section id="estimating-cause-specific-cumulative-incidence-using-ipw" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="estimating-cause-specific-cumulative-incidence-using-ipw">Estimating cause-specific cumulative incidence using IPW</h2>
<p>From now on, say that the main event of interest is recurrence, with the competing event of death (without recurrence) being present.</p>
<ol type="1">
<li>Calculate and plot unadjusted marginal cause-specific cumulative incidence for both recurrence and death without recurrence. How do these curves compare to the plot in Part A 1?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cuminc <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(rdtime, rd, <span class="at">type=</span><span class="st">"mstate"</span>) <span class="sc">~</span> hormon, dta)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cuminc, <span class="at">xlab=</span><span class="st">"Time (years)"</span>, <span class="at">ylab=</span><span class="st">"Cumulative incidence"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">"topleft"</span>, <span class="fu">c</span>(<span class="st">"Recurrence (treated)"</span>, <span class="st">"Recurrence (untreated)"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Death (treated)"</span>, <span class="st">"Death (untreated)"</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">bty=</span><span class="st">"n"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_comp_risk_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol start="2" type="1">
<li>Calculate and plot adjusted marginal cause-specific cumulative incidence for both recurrence and death without recurrence. How would you describe the total effect of treatment on recurrence? To what degree can there be a indirect effect through the competing event of death without recurrence?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cuminc <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(rdtime, rd, <span class="at">type=</span><span class="st">"mstate"</span>) <span class="sc">~</span> hormon, <span class="at">weights=</span>wt, dta)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cuminc, <span class="at">xlab=</span><span class="st">"Time (years)"</span>, <span class="at">ylab=</span><span class="st">"Cumulative incidence"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">"topleft"</span>, <span class="fu">c</span>(<span class="st">"Recurrence (untreated)"</span>, <span class="st">"Recurrence (treated)"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Death (untreated)"</span>, <span class="st">"Death (treated)"</span>),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">bty=</span><span class="st">"n"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_comp_risk_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol start="3" type="1">
<li>Run a test for the difference between cumulative incidence of recurrence and interpret the results.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new dataset for the subdistribution hazard:</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>dta.sub <span class="ot">=</span> <span class="fu">finegray</span>(<span class="fu">Surv</span>(rdtime, rd, <span class="at">type=</span><span class="st">"mstate"</span>) <span class="sc">~</span> ., <span class="at">etype=</span><span class="dv">1</span>, <span class="at">data=</span>dta)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Run weighted Cox model on subdistribution dataset:</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(fgstart, fgstop, fgstatus) <span class="sc">~</span> hormon, <span class="at">id=</span>pid,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">weight=</span>wt<span class="sc">*</span>fgwt, <span class="at">robust=</span>T, <span class="at">data=</span>dta.sub)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(fgstart, fgstop, fgstatus) ~ hormon, data = dta.sub, 
    weights = wt * fgwt, robust = T, id = pid)

            coef exp(coef) se(coef) robust se      z     p
hormon1 -0.17199   0.84199  0.03747   0.14621 -1.176 0.239

Likelihood ratio test=21.12  on 1 df, p=4.315e-06
n= 29673, unique id= 2939, number of events= 1477 </code></pre>
</div>
</div>
<ol start="4" type="1">
<li>Calculate the absolute difference in five year risk of recurrence between the two treatment groups based on the weighted Kaplan-Meier estimates from the prior exercise. Add bootstrap confidence intervals. How do you interpret the results?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate difference in cumulative incidence F(t) at t=5 years:</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>pstate <span class="ot">=</span> <span class="fu">summary</span>(cuminc, <span class="at">times=</span><span class="dv">5</span>)<span class="sc">$</span>pstate</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>Fdiff <span class="ot">=</span> pstate[<span class="dv">2</span>,<span class="dv">2</span>] <span class="sc">-</span> pstate[<span class="dv">1</span>,<span class="dv">2</span>]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>Fdiff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          1 
-0.09252237 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap:</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>fdiff <span class="ot">=</span> <span class="cf">function</span>(data, indices){</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  dataset <span class="ot">=</span> data[indices,]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recalculate weights for each bootstrap sample:</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  mod.treat <span class="ot">=</span> <span class="fu">glm</span>(hormon <span class="sc">~</span> age <span class="sc">+</span> meno <span class="sc">+</span> size <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.factor</span>(grade) <span class="sc">+</span> enodes <span class="sc">+</span> pgr <span class="sc">+</span> er <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>      chemo, <span class="at">data=</span>dataset, <span class="at">family=</span><span class="st">"binomial"</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  pred.treat <span class="ot">=</span> <span class="fu">predict</span>(mod.treat, <span class="at">data=</span>dataset, <span class="at">type=</span><span class="st">"response"</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>wt <span class="ot">=</span> (dataset<span class="sc">$</span>hormon<span class="sc">==</span><span class="dv">1</span>)<span class="sc">/</span>pred.treat <span class="sc">+</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    (dataset<span class="sc">$</span>hormon<span class="sc">==</span><span class="dv">0</span>)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pred.treat)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate weighed difference in cumulative incidence:</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  cuminc <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(rdtime, rd, <span class="at">type=</span><span class="st">"mstate"</span>) <span class="sc">~</span> hormon, <span class="at">weights=</span>wt, dataset)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  pstate <span class="ot">=</span> <span class="fu">summary</span>(cuminc, <span class="at">times=</span><span class="dv">5</span>)<span class="sc">$</span>pstate</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pstate[<span class="dv">2</span>,<span class="dv">2</span>] <span class="sc">-</span> pstate[<span class="dv">1</span>,<span class="dv">2</span>])</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">=</span> <span class="fu">boot</span>(<span class="at">data=</span>dta, <span class="at">statistic=</span>fdiff, <span class="at">R=</span><span class="dv">100</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>b1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
ORDINARY NONPARAMETRIC BOOTSTRAP


Call:
boot(data = dta, statistic = fdiff, R = 100)


Bootstrap Statistics :
       original       bias    std. error
t1* -0.09252237 -0.002111384  0.04551915</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(b1, <span class="at">type=</span><span class="fu">c</span>(<span class="st">"perc"</span>, <span class="st">"norm"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on 100 bootstrap replicates

CALL : 
boot.ci(boot.out = b1, type = c("perc", "norm"))

Intervals : 
Level      Normal             Percentile     
95%   (-0.1796, -0.0012 )   (-0.1906, -0.0025 )  
Calculations and Intervals on Original Scale
Some percentile intervals may be unstable</code></pre>
</div>
</div>
<ol start="5" type="1">
<li>Repeat exercise 3, but now for the <strong>restricted mean</strong> (recurrence free) time lost (RMTL) to recurrence after five years. Interpret the results.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate difference in RMTL at 5 years:</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>rmtl <span class="ot">=</span> <span class="fu">summary</span>(cuminc, <span class="at">rmean=</span><span class="dv">5</span>)<span class="sc">$</span>table</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>rmtl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  n     nevent      rmean  se(rmean)
hormon=0, (s0) 2605    0.00000 3.69900478 0.03463876
hormon=1, (s0)  334    0.00000 4.11459536 0.11769994
hormon=0, 1    2605 1524.52988 1.22911433 0.03444235
hormon=1, 1     334 1342.60996 0.84317703 0.11566147
hormon=0, 2    2605  142.32192 0.07188089 0.01023798
hormon=1, 2     334   69.73814 0.04222762 0.01360438</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>RMTLdiff <span class="ot">=</span> rmtl[<span class="dv">4</span>, <span class="dv">3</span>] <span class="sc">-</span> rmtl[<span class="dv">3</span>, <span class="dv">3</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>RMTLdiff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.3859373</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap:</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>fdiff <span class="ot">=</span> <span class="cf">function</span>(data, indices){</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  dataset <span class="ot">=</span> data[indices,]</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recalculate weights for each bootstrap sample:</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  mod.treat <span class="ot">=</span> <span class="fu">glm</span>(hormon <span class="sc">~</span> age <span class="sc">+</span> meno <span class="sc">+</span> size <span class="sc">+</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.factor</span>(grade) <span class="sc">+</span> enodes <span class="sc">+</span> pgr <span class="sc">+</span> er <span class="sc">+</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>      chemo, <span class="at">data=</span>dataset, <span class="at">family=</span><span class="st">"binomial"</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  pred.treat <span class="ot">=</span> <span class="fu">predict</span>(mod.treat, <span class="at">data=</span>dataset, <span class="at">type=</span><span class="st">"response"</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>wt <span class="ot">=</span> (dataset<span class="sc">$</span>hormon<span class="sc">==</span><span class="dv">1</span>)<span class="sc">/</span>pred.treat <span class="sc">+</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    (dataset<span class="sc">$</span>hormon<span class="sc">==</span><span class="dv">0</span>)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>pred.treat)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate weighed difference in cumulative incidence:</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  cuminc <span class="ot">=</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(rdtime, rd, <span class="at">type=</span><span class="st">"mstate"</span>) <span class="sc">~</span> hormon, <span class="at">weights=</span>wt, dataset)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  rmtl <span class="ot">=</span> <span class="fu">summary</span>(cuminc, <span class="at">rmean=</span><span class="dv">5</span>)<span class="sc">$</span>table</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(rmtl[<span class="dv">4</span>, <span class="dv">3</span>] <span class="sc">-</span> rmtl[<span class="dv">3</span>, <span class="dv">3</span>])</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>b2 <span class="ot">=</span> <span class="fu">boot</span>(<span class="at">data=</span>dta, <span class="at">statistic=</span>fdiff, <span class="at">R=</span><span class="dv">100</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>b2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
ORDINARY NONPARAMETRIC BOOTSTRAP


Call:
boot(data = dta, statistic = fdiff, R = 100)


Bootstrap Statistics :
      original      bias    std. error
t1* -0.3859373 0.001982641   0.1115977</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(b2, <span class="at">type=</span><span class="fu">c</span>(<span class="st">"perc"</span>, <span class="st">"norm"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on 100 bootstrap replicates

CALL : 
boot.ci(boot.out = b2, type = c("perc", "norm"))

Intervals : 
Level      Normal             Percentile     
95%   (-0.6066, -0.1692 )   (-0.6164, -0.1376 )  
Calculations and Intervals on Original Scale
Some percentile intervals may be unstable</code></pre>
</div>
</div>
<ol start="6" type="1">
<li>EXTRA: Make a plot of the difference between the cumulative incidence curves from <span class="math inline">\(t=0\)</span> to <span class="math inline">\(t=10\)</span> and interpret the results (hint: utilize the <code>stepfun</code> function)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>Fa1 <span class="ot">=</span> <span class="fu">stepfun</span>(cuminc[<span class="st">"hormon=1"</span>,]<span class="sc">$</span>time, <span class="fu">c</span>(<span class="dv">0</span>, cuminc[<span class="st">"hormon=1"</span>,]<span class="sc">$</span>pstate[,<span class="dv">2</span>]), <span class="at">right=</span>T)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>Fa0 <span class="ot">=</span> <span class="fu">stepfun</span>(cuminc[<span class="st">"hormon=0"</span>,]<span class="sc">$</span>time, <span class="fu">c</span>(<span class="dv">0</span>, cuminc[<span class="st">"hormon=0"</span>,]<span class="sc">$</span>pstate[,<span class="dv">2</span>]), <span class="at">right=</span>T)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>times <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">by=</span><span class="fl">0.01</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(times, <span class="fu">Fa1</span>(times) <span class="sc">-</span> <span class="fu">Fa0</span>(times), <span class="at">type=</span><span class="st">"s"</span>, <span class="at">lty=</span><span class="dv">3</span>, <span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab=</span><span class="st">"Cumulative incidence difference"</span>, <span class="at">xlab=</span><span class="st">"Time (years)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_comp_risk_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="estimating-cause-specific-cumulative-incidence-using-standardisation-g-formula" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="estimating-cause-specific-cumulative-incidence-using-standardisation-g-formula">Estimating cause-specific cumulative incidence using standardisation (g-formula)</h2>
<ol type="1">
<li>Fit a Cox proportional hazard model for the cause specific hazard of each event (recurrence and death without recurrence), adjusting for hormon, age, meno, size, grade, enodes, pgr, er and chemo. How would you interpret the output?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>c1 <span class="ot">=</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(rdtime, rd, <span class="at">type=</span><span class="st">"mstate"</span>) <span class="sc">~</span> hormon <span class="sc">+</span> age <span class="sc">+</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    meno <span class="sc">+</span> size <span class="sc">+</span> <span class="fu">as.factor</span>(grade) <span class="sc">+</span> enodes <span class="sc">+</span> pgr <span class="sc">+</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    er <span class="sc">+</span> chemo, <span class="at">id=</span>pid, dta)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>c1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(rdtime, rd, type = "mstate") ~ hormon + 
    age + meno + size + as.factor(grade) + enodes + pgr + er + 
    chemo, data = dta, id = pid)

                   
1:2                       coef  exp(coef)   se(coef)  robust se       z
  hormon1           -3.016e-01  7.396e-01  8.503e-02  8.880e-02  -3.397
  age               -1.531e-02  9.848e-01  3.572e-03  3.871e-03  -3.954
  meno               1.579e-01  1.171e+00  9.071e-02  9.679e-02   1.632
  size20-50          3.114e-01  1.365e+00  5.964e-02  5.975e-02   5.211
  size&gt;50            4.991e-01  1.647e+00  9.064e-02  9.883e-02   5.050
  as.factor(grade)3  3.454e-01  1.413e+00  6.611e-02  6.478e-02   5.332
  enodes            -1.929e+00  1.453e-01  1.009e-01  1.185e-01 -16.279
  pgr               -9.318e-05  9.999e-01  1.073e-04  1.097e-04  -0.849
  er                -6.956e-05  9.999e-01  1.061e-04  1.119e-04  -0.622
  chemo             -3.134e-01  7.309e-01  7.336e-02  7.655e-02  -4.095
                   
1:2                        p
  hormon1           0.000682
  age               7.67e-05
  meno              0.102761
  size20-50         1.87e-07
  size&gt;50           4.41e-07
  as.factor(grade)3 9.69e-08
  enodes             &lt; 2e-16
  pgr               0.395650
  er                0.534111
  chemo             4.23e-05

                   
1:3                       coef  exp(coef)   se(coef)  robust se      z       p
  hormon1           -0.3382738  0.7130000  0.2657453  0.2598436 -1.302 0.19297
  age                0.1346077  1.1440878  0.0122801  0.0124025 10.853 &lt; 2e-16
  meno              -0.5160600  0.5968676  0.4601891  0.4658301 -1.108 0.26794
  size20-50          0.1388994  1.1490085  0.2007498  0.2038521  0.681 0.49564
  size&gt;50            0.2992439  1.3488385  0.2873388  0.2851762  1.049 0.29403
  as.factor(grade)3 -0.0180504  0.9821115  0.1990415  0.1960833 -0.092 0.92665
  enodes            -1.1990698  0.3014745  0.3621725  0.3346957 -3.583 0.00034
  pgr                0.0001656  1.0001656  0.0003013  0.0002582  0.641 0.52133
  er                -0.0002871  0.9997130  0.0003064  0.0003764 -0.763 0.44563
  chemo              0.0429707  1.0439073  0.4871352  0.4957296  0.087 0.93092

 States:  1= (s0), 2= 1, 3= 2 

Likelihood ratio test=851.2  on 20 df, p=&lt; 2.2e-16
n= 2939, unique id= 2939, number of events= 1612 </code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Use the Cox model you just fitted to predict the event probabilities from <span class="math inline">\(t=0\)</span> to <span class="math inline">\(t=10\)</span> for an individual with hormon, age, size and grade at the same values as the first individual in the dataset (pid=1) and all other covariates equal to 0.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="at">hormon =</span> dta<span class="sc">$</span>hormon[<span class="dv">1</span>], <span class="at">age =</span> dta<span class="sc">$</span>age[<span class="dv">1</span>], <span class="at">meno =</span> <span class="fu">c</span>(<span class="dv">0</span>),</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> dta<span class="sc">$</span>size[<span class="dv">1</span>], <span class="at">grade =</span> dta<span class="sc">$</span>grade[<span class="dv">1</span>], <span class="at">enodes =</span> <span class="fu">c</span>(<span class="dv">0</span>),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">pgr =</span> <span class="fu">c</span>(<span class="dv">0</span>), <span class="at">er =</span> <span class="fu">c</span>(<span class="dv">0</span>), <span class="at">chemo =</span> <span class="fu">c</span>(<span class="dv">0</span>))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>cuminc.pred <span class="ot">=</span> <span class="fu">survfit</span>(c1, <span class="at">newdata=</span>nd)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cuminc.pred, <span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>), <span class="at">ylab=</span><span class="st">"Cumulative incidence"</span>, <span class="at">xlab=</span><span class="st">"Time"</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">"topleft"</span>, <span class="fu">c</span>(<span class="st">"Recurrence"</span>, <span class="st">"Death"</span>), <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>), <span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="at">bty=</span><span class="st">"n"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_comp_risk_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ol start="3" type="1">
<li>Calculate marginal adjusted cumulative incidence curves for recurrence by standardisation (g-formula). How do the resulting curves compare to the inverse probability weighted curves produced earlier?</li>
</ol>
<p>Hint: Predict cumulative incidence as in the previous exercise, for every individual in the dataset, fixing treatment to 1 and then, again, to 0.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict cumulative incidence for hormon=1 and hormon=0, with observed values of L:</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>nd1 <span class="ot">=</span> dta</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>nd0 <span class="ot">=</span> dta</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>nd1<span class="sc">$</span>hormon <span class="ot">=</span> <span class="st">"1"</span>; nd0<span class="sc">$</span>hormon <span class="ot">=</span> <span class="st">"0"</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>cuminc<span class="fl">.1</span> <span class="ot">=</span> <span class="fu">survfit</span>(c1, <span class="at">newdata=</span>nd1)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>cuminc<span class="fl">.0</span> <span class="ot">=</span> <span class="fu">survfit</span>(c1, <span class="at">newdata=</span>nd0)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Average over individual predictions and plot:</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cuminc<span class="fl">.0</span><span class="sc">$</span>time, <span class="fu">rowMeans</span>(cuminc<span class="fl">.0</span><span class="sc">$</span>pstate[,,<span class="dv">2</span>]), <span class="at">type=</span><span class="st">"s"</span>, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">3</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab=</span><span class="st">"Time"</span>, <span class="at">ylab=</span><span class="st">"Cumulative incidence"</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(cuminc<span class="fl">.1</span><span class="sc">$</span>time, <span class="fu">rowMeans</span>(cuminc<span class="fl">.1</span><span class="sc">$</span>pstate[,,<span class="dv">2</span>]), <span class="at">type=</span><span class="st">"s"</span>, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">3</span>)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="at">x=</span><span class="st">"topleft"</span>, <span class="fu">c</span>(<span class="st">"Recurrence (untreated)"</span>, <span class="st">"Recurrence (treated)"</span>),</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lwd=</span><span class="dv">2</span>, <span class="at">lty=</span><span class="dv">3</span>, <span class="at">bty=</span><span class="st">"n"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="causal_comp_risk_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="./sustained_trts.html" class="pagination-link" aria-label="Marginal structural models and g-formula for sustained treatment strategies">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Marginal structural models and g-formula for sustained treatment strategies</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>